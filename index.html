<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Growfax.shop — Role Shop & Top-up (with BNI proof upload)</title>
<meta name="description" content="Growfax role shop with wallet simulation, DANA/PayPal deep links, BNI proof upload and admin verification.">
<style>
:root{
  --accent: #00ffe0;
  --bg-1: #050505;
  --card:#0f1513;
  --muted: #9fcdbf;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background: linear-gradient(180deg,#050505 0%, #07120b 60%);
  color:#e9fff6;
  -webkit-font-smoothing:antialiased;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}
/* Header */
.header{
  width:100%; max-width:1100px; padding:18px; display:flex; align-items:center; justify-content:space-between;
}
.brand{display:flex; gap:12px; align-items:center}
.brand img{height:56px;border-radius:10px;box-shadow:0 10px 30px rgba(0,255,224,0.06)}
.brand h1{margin:0;color:var(--accent);font-size:1.1rem}
.wallet{display:flex;gap:10px;align-items:center}
.balance{background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;color:var(--accent);font-weight:700}
.topup-btn{background:linear-gradient(90deg,var(--accent),#0077ff);padding:8px 12px;border-radius:10px;color:#021;border:none;cursor:pointer;font-weight:700}

/* Layout */
.container{width:100%;max-width:1100px;padding:12px 18px 80px}
.banner{width:92%;max-width:760px;border-radius:12px;box-shadow:0 12px 40px rgba(0,255,224,0.04);margin:8px auto}
.section{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));border-radius:12px;padding:18px;margin:18px 0;box-shadow:0 8px 30px rgba(0,0,0,0.35)}
.section h2{margin:0 0 12px 0;color:var(--accent)}

/* Grid & Cards */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
.card{background:var(--card);padding:14px;border-radius:10px;min-height:120px;display:flex;flex-direction:column;justify-content:space-between;box-shadow:0 8px 20px rgba(0,0,0,0.5)}
.card h3{margin:0;color:var(--accent)}
.card p{margin:6px 0 0 0;color:#d6efe6}

/* Buttons */
.btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn-primary{background:linear-gradient(90deg,var(--accent),#0077ff,#ff00ff);background-size:300% 300%;animation:rgbflow 5s linear infinite;color:#021}
.btn-ghost{background:rgba(255,255,255,0.03);color:#dff7ee}
.btn-copy{background:#0f0f0f;color:var(--accent);border:1px solid rgba(255,255,255,0.04)}

/* Modal */
.modal-back{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.78);backdrop-filter:blur(8px);z-index:1200;align-items:center;justify-content:center}
.modal{width:92%;max-width:680px;background:#0b0f0f;border-radius:12px;padding:18px;box-shadow:0 18px 60px rgba(0,0,0,0.6);position:relative}
.close-x{position:absolute;right:16px;top:12px;cursor:pointer;color:#9fcdbf;font-weight:700}

/* table */
.table-wrap{overflow:auto;max-height:52vh;border-radius:8px;background:#060706;padding:8px}
.table{width:100%;border-collapse:collapse;color:#e9fff6}
.table th{position:sticky;top:0;background:rgba(0,0,0,0.2);color:var(--accent);padding:8px;text-align:left}
.table td{padding:8px;border-bottom:1px solid rgba(0,255,224,0.03)}

/* small */
.note{color:#bcd9d0;font-size:.95rem}
.status-pending{color:#ffd700;font-weight:700}
.status-confirmed{color:var(--accent);font-weight:700}
@keyframes rgbflow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
@media(max-width:640px){ .header{flex-direction:column;align-items:flex-start} .banner{width:96%} }
</style>
</head>
<body>

<div class="header">
  <div class="brand">
    <img src="https://vivj-cosr.github.io/growfax.shop/Growfax_banner.png" alt="Growfax banner">
    <div>
      <h1>Growfax.shop</h1>
      <div style="font-size:0.85rem;color:var(--muted)">Role shop • Top-up & admin verification</div>
    </div>
  </div>

  <div class="wallet">
    <div class="balance" id="balanceDisplay">Rp 0</div>
    <button class="topup-btn" id="openTopup">Top-Up</button>
  </div>
</div>

<div class="container">
  <img class="banner" src="https://vivj-cosr.github.io/growfax.shop/Growfax_banner.png" alt="banner">

  <section class="section">
    <h2>Top-up Balance</h2>
    <div style="max-width:800px;margin:auto;text-align:left;color:#cfeee5">
      Enter your in-game name, amount and choose a payment method. For DANA the page will attempt to open the DANA app (mobile deep link) with number and amount pre-filled. For PayPal it opens your PayPal.me link. For BNI you will upload a proof image — proof is sent to the Discord admin channel for verification.
    </div>
  </section>

  <section class="section">
    <h2>Roles</h2>
    <div class="grid" id="rolesGrid"></div>
  </section>

  <section class="section">
    <h2>Top-up status / pending</h2>
    <div id="pendingList">No pending top-ups.</div>
  </section>

  <section class="section">
    <h2>Transaction history (local)</h2>
    <div id="historyList">No history yet.</div>
  </section>
</div>

<footer style="margin-bottom:40px">© 2025 VivJ — Powered by Growfax • <span style="cursor:pointer;color:var(--accent)" id="openAdminLink">Admin</span></footer>

<!-- TOPUP MODAL -->
<div class="modal-back" id="topupModal">
  <div class="modal">
    <div class="close-x" onclick="closeTopup()">✖</div>
    <h3>Top-up</h3>
    <div style="text-align:left">
      <label>In-game name / Discord</label><br>
      <input id="topupName" type="text" placeholder="Your Growtopia name or Discord" style="width:100%;padding:10px;border-radius:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.03);color:#e9fff6">
      <label style="margin-top:8px;display:block">Amount (IDR)</label>
      <input id="topupAmount" type="number" placeholder="Enter amount (e.g. 50000)" style="width:100%;padding:10px;border-radius:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.03);color:#e9fff6">
      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="startTopup('PayPal')">PayPal</button>
        <button class="btn btn-primary" onclick="startTopup('DANA')">DANA (try open app)</button>
        <button class="btn btn-primary" onclick="showBNIProofForm()">BNI (upload proof)</button>
      </div>

      <div id="bniForm" style="display:none;margin-top:14px">
        <hr style="border-color: rgba(255,255,255,0.03)">
        <div style="text-align:left">
          <div style="font-weight:700;color:var(--accent)">BNI account</div>
          <div style="margin-top:6px">Account: <strong>1949656911</strong> (a.n. VivJ)</div>
          <div style="margin-top:6px;color:#cfeee5">Upload your bank transfer proof (photo):</div>
          <input id="bniSender" type="text" placeholder="Sender name (as on bank)" style="width:100%;padding:8px;border-radius:8px;margin-top:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.03);color:#e9fff6">
          <input id="bniAmount" type="number" placeholder="Amount transferred (IDR)" style="width:100%;padding:8px;border-radius:8px;margin-top:8px;background:#0b0b0b;border:1px solid rgba(255,255,255,0.03);color:#e9fff6">
          <input id="bniFile" type="file" accept="image/*" style="margin-top:8px;width:100%">
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="btn btn-primary" onclick="submitBNIProof()">Send proof</button>
            <button class="btn btn-ghost" onclick="hideBNIProofForm()">Cancel</button>
          </div>
          <div class="note" style="margin-top:8px">After sending proof, admin will receive the image in Discord and will verify manually. Your pending entry will be listed below.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN MODAL -->
<div class="modal-back" id="adminModal">
  <div class="modal">
    <div class="close-x" onclick="closeAdmin()">✖</div>
    <h3>Admin Panel</h3>
    <div class="note" style="margin-bottom:10px">Password required. Use this panel to confirm pending BNI/DANA/PayPal transfers. Confirming adds the amount to the user's local wallet (they must use the same browser or you must share confirmation ID with them).</div>

    <div class="table-wrap">
      <table class="table" id="adminTable">
        <thead><tr><th>#</th><th>User</th><th>Method</th><th>Amount</th><th>Status</th><th>Time</th><th>Action</th></tr></thead>
        <tbody id="adminTbody"></tbody>
      </table>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
      <button class="btn btn-primary" onclick="exportLogs()">Export logs</button>
      <button class="btn btn-ghost" onclick="clearAllLocal()">Clear local logs & balances</button>
    </div>
  </div>
</div>

<script>
/* ------------- CONFIG ------------- */
const DISCORD_WEBHOOK = "https://discord.com/api/webhooks/1433382270886219817/JVLQ4Ei1IB94vMiEgowjOhmL_OkPcotKesB6mEsjjPKYdRnuVhoo_PgsWrWGkYyHkjk5";
const PAYPAL_ME = "https://paypal.me/BilzXd1"; // we'll append amount if provided
const DANA_PHONE = "0895338912670";
const DANA_WEB_FALLBACK = "https://link.dana.id/m"; // fallback web if deep link not available
const BNI_ACCOUNT = "1949656911 (a.n. VivJ)";
const ADMIN_PASSWORD = "azzahran111";

/* ------------- STORAGE helpers ------------- */
function getBalance(){ return Number(localStorage.getItem("gw_balance") || 0); }
function setBalance(val){ localStorage.setItem("gw_balance", Math.max(0, Math.round(val))); updateBalanceDisplay(); }
function getPending(){ return JSON.parse(localStorage.getItem("gw_pending") || "[]"); }
function setPending(arr){ localStorage.setItem("gw_pending", JSON.stringify(arr)); renderPending(); }
function pushPending(obj){ const p = getPending(); p.push(obj); setPending(p); }
function getHistory(){ return JSON.parse(localStorage.getItem("gw_history") || "[]"); }
function pushHistory(obj){ const h = getHistory(); h.push(obj); localStorage.setItem("gw_history", JSON.stringify(h)); renderHistory(); }
function clearAll(){ localStorage.removeItem("gw_pending"); localStorage.removeItem("gw_history"); localStorage.removeItem("gw_balance"); updateBalanceDisplay(); renderPending(); renderHistory(); }

/* ------------- UI init ------------- */
document.getElementById("openTopup").addEventListener("click", ()=>{ openTopup(); });
document.getElementById("openAdminLink").addEventListener("click", ()=>{ openAdmin(); });
updateBalanceDisplay();
renderRoles();
renderPending();
renderHistory();

/* ------------- Roles rendering ------------- */
const ROLES = [
  {id:1, name:"VIP", price:25000},
  {id:2, name:"VIP+", price:50000},
  {id:3, name:"Moderator", price:100000},
  {id:4, name:"Super Moderator", price:200000}
];

function renderRoles(){
  const grid = document.getElementById("rolesGrid");
  grid.innerHTML = "";
  ROLES.forEach(r=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div><h3>${r.name}</h3><p>${formatIDR(r.price)}</p></div>
      <div style="display:flex;align-items:center;justify-content:space-between">
        <button class="btn btn-primary" onclick="attemptBuy(${r.id})">Buy</button>
        <div style="font-size:0.9rem;color:var(--muted)">ID:${r.id}</div>
      </div>`;
    grid.appendChild(card);
  });
}

/* ------------- Balance UI & history ------------- */
function updateBalanceDisplay(){ document.getElementById("balanceDisplay").innerText = formatIDR(getBalance()); }

function renderHistory(){
  const h = getHistory();
  const el = document.getElementById("historyList");
  if(!h || h.length===0){ el.innerHTML = "<i>No history yet.</i>"; return; }
  el.innerHTML = h.slice().reverse().map(i=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">${i.time} — ${i.text}</div>`).join("");
}

/* ------------- Pending UI ------------- */
function renderPending(){
  const p = getPending();
  const el = document.getElementById("pendingList");
  if(!p || p.length===0){ el.innerHTML = "<i>No top-up pending.</i>"; return; }
  el.innerHTML = p.slice().reverse().map((it, idx)=>{
    const statusClass = it.status === "Pending" ? "status-pending" : "status-confirmed";
    return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">
      <strong>${it.user}</strong> — ${formatIDR(it.amount)} via ${it.method}
      <span style="float:right" class="${statusClass}">${it.status}</span>
      <div style="margin-top:6px;color:#bfeee6;font-size:0.95rem">${it.time}</div>
      ${it.proofUrl ? `<div style="margin-top:6px"><a href="${it.proofUrl}" target="_blank">View proof image</a></div>` : ""}
    </div>`;
  }).join("");
}

/* ------------- Topup flow ------------- */
function openTopup(){
  document.getElementById("topupName").value = "";
  document.getElementById("topupAmount").value = "";
  document.getElementById("bniForm").style.display = "none";
  document.getElementById("topupModal").style.display = "flex";
}
function closeTopup(){ document.getElementById("topupModal").style.display = "none"; }

function formatIDR(n){ return "Rp " + Number(n).toLocaleString('id-ID'); }

/* Try deep link open helper: attempt to open a deep link, fallback to web URL after brief delay */
function openDeepLink(deep, fallback){
  // Try to open in mobile app. This approach uses an iframe for legacy or window.location for modern browsers.
  const now = Date.now();
  // first try with window.location (works on some mobile browsers)
  let opened = false;
  try {
    window.location = deep;
    opened = true;
  } catch(e){}
  // set fallback after 1s if not opened (can't accurately detect, use timeout)
  setTimeout(()=>{
    // If user is on desktop or deep link didn't open, open fallback web link
    if(Date.now() - now < 1200){ /* attempt fallback */ }
    window.open(fallback, "_blank");
  }, 900);
}

/* Start topup - for PayPal and DANA we open links, for BNI we show form */
function startTopup(method){
  const user = document.getElementById("topupName").value.trim();
  const amount = Math.round(Number(document.getElementById("topupAmount").value || 0));
  if(!user || !amount || amount <= 0){ alert("Please enter your name and a valid amount."); return; }

  // validations (DANA min 50)
  if(method === "DANA" && amount < 50){
    alert("DANA test transfers require at least Rp 50.");
    return;
  }
  // For PayPal and DANA we'll open external and still create a pending record (admin must confirm)
  if(method === "PayPal"){
    // Build paypal.me link with amount (in IDR we can't force PayPal currency; we just open link)
    const url = PAYPAL_ME + (amount ? ("/" + amount) : "");
    // create pending
    const pendingEntry = { id: genId(), user, method, amount, status:"Pending", time: new Date().toLocaleString(), proofUrl:null };
    pushPending(pendingEntry);
    // send discord notification
    sendDiscord(`📥 Top-up pending\nUser: ${user}\nMethod: PayPal\nAmount: ${formatIDR(amount)}\nTime: ${pendingEntry.time}`);
    // open paypal
    window.open(url, "_blank");
    closeTopup();
    alert("A pending top-up has been recorded. Please complete payment on PayPal and wait for admin verification.");
    return;
  }
  if(method === "DANA"){
    const deep = `dana://transfer?phone=${DANA_PHONE}&amount=${amount}`;
    const fallback = `${DANA_WEB_FALLBACK}`;
    const pendingEntry = { id: genId(), user, method, amount, status:"Pending", time: new Date().toLocaleString(), proofUrl:null };
    pushPending(pendingEntry);
    sendDiscord(`📥 Top-up pending\nUser: ${user}\nMethod: DANA\nAmount: ${formatIDR(amount)}\nTime: ${pendingEntry.time}`);
    // attempt deep link then fallback
    openDeepLink(deep, fallback);
    closeTopup();
    alert("If your DANA app opened, confirm the transfer there. Otherwise a DANA web page has been opened. A pending top-up was created — admin will verify.");
    return;
  }
  if(method === "BNI"){
    // show BNI proof upload form inside modal
    document.getElementById("bniForm").style.display = "block";
    // prefill fields
    document.getElementById("bniSender").value = user;
    document.getElementById("bniAmount").value = amount;
    return;
  }
}

/* Show BNI proof upload form */
function showBNIProofForm(){
  document.getElementById("bniForm").style.display = "block";
}

/* hide BNI form */
function hideBNIProofForm(){
  document.getElementById("bniForm").style.display = "none";
}

/* Submit BNI proof: sends an attachment to Discord webhook as multipart form-data payload_json + file */
async function submitBNIProof(){
  const sender = document.getElementById("bniSender").value.trim();
  const amount = Math.round(Number(document.getElementById("bniAmount").value || 0));
  const fileInput = document.getElementById("bniFile");
  if(!sender || !amount || amount <= 0){ alert("Please enter sender name and valid amount."); return; }
  if(!fileInput.files || fileInput.files.length === 0){ alert("Please choose a proof image file to upload."); return; }

  const file = fileInput.files[0];
  // Create pending entry locally first
  const entry = { id: genId(), user: sender, method:"BNI", amount, status:"Pending", time: new Date().toLocaleString(), proofUrl: null };
  pushPending(entry);

  // Prepare FormData for Discord webhook: payload_json + file
  const payload = {
    content: `📤 New BNI proof received\nUser: ${sender}\nAmount: ${formatIDR(amount)}\nTime: ${entry.time}\nLocalID: ${entry.id}`,
    username: "Growfax Bot"
  };
  const fd = new FormData();
  fd.append('payload_json', JSON.stringify(payload));
  // attach the file; Discord will show it as an attachment
  fd.append('file', file, file.name);

  // Try to POST to webhook
  try{
    const res = await fetch(DISCORD_WEBHOOK, { method: "POST", body: fd });
    if(!res.ok){
      console.warn("Webhook upload may have failed", res.status);
      alert("Proof sent locally but Discord upload returned status " + res.status + ". Admin may not receive it.");
    } else {
      // Discord accepted it
    }
  }catch(err){
    console.warn("Webhook POST error", err);
    alert("Failed to send proof to Discord webhook. Check console for details.");
  }

  // Save local pending entry; we don't have a public file URL to show so proofUrl remains null
  // update UI
  renderPending();
  closeTopup();
  alert("BNI proof submitted. Your top-up is pending admin verification.");
}

/* ------------- Admin UI & actions ------------- */
function openAdmin(){
  const pw = prompt("Enter admin password:");
  if(!pw) return;
  if(pw !== ADMIN_PASSWORD){ alert("Wrong password."); return; }
  document.getElementById("adminModal").style.display = "flex";
  renderAdminTable();
}
function closeAdmin(){ document.getElementById("adminModal").style.display = "none"; }

function renderAdminTable(){
  const tbody = document.getElementById("adminTbody");
  const pending = getPending();
  tbody.innerHTML = "";
  if(!pending || pending.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7"><i>No pending top-ups.</i></td>`;
    tbody.appendChild(tr);
    return;
  }
  pending.forEach((p, idx)=>{
    const tr = document.createElement("tr");
    const proofLink = p.proofUrl ? `<a href="${p.proofUrl}" target="_blank">view</a>` : "-";
    tr.innerHTML = `<td style="padding:8px">${idx+1}</td>
      <td style="padding:8px">${escapeHtml(p.user)}</td>
      <td style="padding:8px">${p.method}</td>
      <td style="padding:8px">${formatIDR(p.amount)}</td>
      <td style="padding:8px">${p.status}</td>
      <td style="padding:8px">${p.time}</td>
      <td style="padding:8px">
        ${p.status === "Pending" ? `<button class="btn btn-primary" onclick="confirmPending('${p.id}')">Confirm</button>
                                   <button class="btn btn-ghost" onclick="rejectPending('${p.id}')">Reject</button>` : '-'}
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Confirm a pending top-up: set status, add to local balance, push history, send discord message */
function confirmPending(id){
  const pending = getPending();
  const idx = pending.findIndex(x => x.id === id);
  if(idx === -1){ alert("Pending item not found."); return; }
  const item = pending[idx];
  if(item.status !== "Pending"){ alert("Item already processed."); return; }
  item.status = "Confirmed";
  // add to balance
  const current = getBalance();
  setBalance(current + Number(item.amount));
  // history
  pushHistory({ time: new Date().toLocaleString(), text: `Top-up confirmed: ${item.user} +${formatIDR(item.amount)} (${item.method})` });
  setPending(pending);
  // notify discord
  sendDiscord(`✅ Top-up confirmed\nUser: ${item.user}\nMethod: ${item.method}\nAmount: ${formatIDR(item.amount)}\nTime: ${item.time}`);
  renderAdminTable();
  alert("Confirmed and balance updated.");
}

/* Reject a pending top-up */
function rejectPending(id){
  if(!confirm("Reject this pending top-up?")) return;
  const pending = getPending();
  const idx = pending.findIndex(x => x.id === id);
  if(idx === -1) return;
  const item = pending[idx];
  item.status = "Rejected";
  // move to history as rejected note
  pushHistory({ time: new Date().toLocaleString(), text: `Top-up rejected: ${item.user} (${formatIDR(item.amount)}) method: ${item.method}` });
  setPending(pending);
  sendDiscord(`❌ Top-up rejected\nUser: ${item.user}\nMethod: ${item.method}\nAmount: ${formatIDR(item.amount)}\nTime: ${item.time}`);
  renderAdminTable();
}

/* ------------- Buy flow ------------- */
function attemptBuy(roleId){
  const r = ROLES.find(x=>x.id === roleId);
  if(!r) return;
  if(getBalance() < r.price){ alert("Insufficient balance. Please top-up first."); return; }
  if(!confirm(`Buy ${r.name} for ${formatIDR(r.price)} using your balance?`)) return;
  // debit
  const newBal = getBalance() - r.price;
  setBalance(newBal);
  pushHistory({ time: new Date().toLocaleString(), text: `Purchased ${r.name} for ${formatIDR(r.price)}` });
  sendDiscord(`🛒 Role purchased\nRole: ${r.name}\nPrice: ${formatIDR(r.price)}\nTime: ${new Date().toLocaleString()}`);
  alert("Purchase recorded. Admin will verify and apply in-game if needed.");
  renderHistory();
}

/* ------------- Utilities ------------- */
function genId(){ return 'id-' + Math.random().toString(36).slice(2,10); }

function sendDiscord(msg){
  // simple JSON webhook for text messages
  fetch(DISCORD_WEBHOOK, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content: msg })
  }).catch(err => console.warn("Webhook error:", err));
}

function escapeHtml(unsafe) {
  return unsafe
       .replace(/&/g, "&amp;")
       .replace(/</g, "&lt;")
       .replace(/>/g, "&gt;")
       .replace(/"/g, "&quot;")
       .replace(/'/g, "&#039;");
}

/* Export logs */
function exportLogs(){
  const logs = {pending:getPending(), history:getHistory(), balance:getBalance()};
  const blob = new Blob([JSON.stringify(logs, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "growfax_logs.json"; a.click();
  URL.revokeObjectURL(url);
}

/* Clear all local data */
function clearAllLocal(){
  if(!confirm("Clear all local pending logs, history and balance? This is irreversible on this browser.")) return;
  clearAll();
  renderAdminTable();
  alert("Local data cleared.");
}

/* ------------- Initial render helpers ------------- */
function renderHistory(){ // override earlier stub to ensure called
  const h = getHistory();
  const el = document.getElementById("historyList");
  if(!h || h.length===0){ el.innerHTML = "<i>No history yet.</i>"; return; }
  el.innerHTML = h.slice().reverse().map(i=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">${i.time} — ${i.text}</div>`).join("");
}
function renderPending(){ // ensure admin table updates
  const p = getPending();
  const el = document.getElementById("pendingList");
  if(!p || p.length===0){ el.innerHTML = "<i>No top-up pending.</i>"; } else {
    el.innerHTML = p.slice().reverse().map(x=>`<div style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)">
      <strong>${escapeHtml(x.user)}</strong> — ${formatIDR(x.amount)} via ${x.method} <span style="float:right" class="${x.status==='Pending'?'status-pending':'status-confirmed'}">(${x.status})</span>
      <div style="color:#9fd9c9;margin-top:6px">${x.time}</div>
      ${x.proofUrl ? `<div style="margin-top:6px"><a href="${x.proofUrl}" target="_blank">View proof</a></div>` : ""}
    </div>`).join("");
  }
  // update admin table if open
  if(document.getElementById("adminModal").style.display === "flex") renderAdminTable();
}
function updateBalanceDisplay(){ document.getElementById("balanceDisplay").innerText = formatIDR(getBalance()); }

/* ------------- Window / click handlers ------------- */
window.onclick = function(e){
  if(e.target === document.getElementById("topupModal")) closeTopup();
  if(e.target === document.getElementById("adminModal")) closeAdmin();
};

/* Kickoff UI */
updateBalanceDisplay();
renderRoles();
renderPending();
renderHistory();
</script>
</body>
</html>
